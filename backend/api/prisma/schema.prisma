// Prisma schema for Live Video Streaming Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  avatar        String?
  company       String?
  title         String?
  role          UserRole  @default(ATTENDEE)
  status        UserStatus @default(OFFLINE)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  events        EventUser[]
  streams       Stream[]
  messages      Message[]
  questions     Question[]
  pollVotes     PollVote[]
  sessions      UserSession[]
  
  @@index([email])
  @@index([role])
}

model UserSession {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token         String    @unique
  ipAddress     String?
  userAgent     String?
  device        String?
  browser       String?
  location      String?
  
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  
  @@index([userId])
  @@index([token])
}

enum UserRole {
  ATTENDEE
  SPEAKER
  MODERATOR
  ADMIN
}

enum UserStatus {
  ONLINE
  AWAY
  OFFLINE
}

// Event Management
model Event {
  id            String    @id @default(uuid())
  title         String
  description   String?
  slug          String    @unique
  thumbnail     String?
  
  // Schedule
  startTime     DateTime
  endTime       DateTime
  timezone      String    @default("America/Sao_Paulo")
  
  // Settings
  status        EventStatus @default(DRAFT)
  isPublic      Boolean   @default(true)
  requiresAuth  Boolean   @default(true)
  maxAttendees  Int?
  
  // Branding
  primaryColor  String?
  logoUrl       String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  users         EventUser[]
  streams       Stream[]
  sessions      EventSession[]
  
  @@index([slug])
  @@index([status])
  @@index([startTime])
}

model EventUser {
  id            String    @id @default(uuid())
  eventId       String
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role          UserRole  @default(ATTENDEE)
  
  // Engagement metrics
  joinedAt      DateTime  @default(now())
  leftAt        DateTime?
  watchTime     Int       @default(0) // in seconds
  engagementScore Int     @default(0)
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model EventSession {
  id            String    @id @default(uuid())
  eventId       String
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?
  speaker       String?
  
  startTime     DateTime
  endTime       DateTime
  
  // Relations
  stream        Stream?
  polls         Poll[]
  questions     Question[]
  messages      Message[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([eventId])
  @@index([startTime])
}

enum EventStatus {
  DRAFT
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
}

// Stream Management
model Stream {
  id            String    @id @default(uuid())
  eventId       String
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sessionId     String?   @unique
  session       EventSession? @relation(fields: [sessionId], references: [id])
  createdById   String
  createdBy     User      @relation(fields: [createdById], references: [id])
  
  // Stream details
  name          String
  streamKey     String    @unique
  playbackUrl   String?
  
  // Source configuration
  source        StreamSource @default(RTMP)
  rtmpUrl       String?
  hlsUrl        String?
  youtubeId     String?
  
  // Status
  status        StreamStatus @default(IDLE)
  isRecording   Boolean   @default(false)
  
  // Quality settings
  qualities     String[]  @default(["1080p", "720p", "480p", "360p"])
  
  // Analytics
  peakViewers   Int       @default(0)
  totalViews    Int       @default(0)
  
  // Timestamps
  startedAt     DateTime?
  endedAt       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  recordings    Recording[]
  
  @@index([eventId])
  @@index([streamKey])
  @@index([status])
}

model Recording {
  id            String    @id @default(uuid())
  streamId      String
  stream        Stream    @relation(fields: [streamId], references: [id], onDelete: Cascade)
  
  filename      String
  path          String
  duration      Int       // in seconds
  size          BigInt    // in bytes
  format        String    @default("mp4")
  
  status        RecordingStatus @default(PROCESSING)
  
  createdAt     DateTime  @default(now())
  
  @@index([streamId])
}

enum StreamSource {
  RTMP
  HLS
  YOUTUBE
  WEBRTC
}

enum StreamStatus {
  IDLE
  CONNECTING
  LIVE
  ENDED
  ERROR
}

enum RecordingStatus {
  PROCESSING
  READY
  ERROR
}

// Chat & Engagement
model Message {
  id            String    @id @default(uuid())
  sessionId     String
  session       EventSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  text          String
  isPinned      Boolean   @default(false)
  isDeleted     Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  
  @@index([sessionId])
  @@index([userId])
  @@index([createdAt])
}

model Question {
  id            String    @id @default(uuid())
  sessionId     String
  session       EventSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  text          String
  upvotes       Int       @default(0)
  isAnswered    Boolean   @default(false)
  isHidden      Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  answeredAt    DateTime?
  
  @@index([sessionId])
  @@index([upvotes])
}

model Poll {
  id            String    @id @default(uuid())
  sessionId     String
  session       EventSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  question      String
  options       PollOption[]
  votes         PollVote[]
  
  isActive      Boolean   @default(true)
  showResults   Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  closedAt      DateTime?
  
  @@index([sessionId])
  @@index([isActive])
}

model PollOption {
  id            String    @id @default(uuid())
  pollId        String
  poll          Poll      @relation(fields: [pollId], references: [id], onDelete: Cascade)
  
  text          String
  order         Int       @default(0)
  
  votes         PollVote[]
  
  @@index([pollId])
}

model PollVote {
  id            String    @id @default(uuid())
  pollId        String
  poll          Poll      @relation(fields: [pollId], references: [id], onDelete: Cascade)
  optionId      String
  option        PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  
  @@unique([pollId, userId])
  @@index([pollId])
  @@index([optionId])
}

// Analytics
model ViewerAnalytics {
  id            String    @id @default(uuid())
  streamId      String
  
  timestamp     DateTime  @default(now())
  viewerCount   Int
  bandwidth     BigInt?   // in bytes
  
  @@index([streamId])
  @@index([timestamp])
}
