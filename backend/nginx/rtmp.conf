# RTMP Configuration for Live Video Streaming
# Handles stream ingestion and triggers transcoding

rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        # Ping/pong for connection health
        ping 30s;
        ping_timeout 10s;
        
        # Notify timeout
        notify_method get;

        # Main live streaming application
        application live {
            live on;
            
            # Enable recording
            record off;
            # record all;
            # record_path /tmp/recordings;
            # record_unique on;
            # record_suffix -%Y%m%d-%H%M%S.flv;
            
            # Authentication - calls API to validate stream key
            on_publish http://127.0.0.1:3000/api/streams/auth/publish;
            on_publish_done http://127.0.0.1:3000/api/streams/auth/publish-done;
            on_play http://127.0.0.1:3000/api/streams/auth/play;
            
            # Notify API when stream starts/stops
            notify_update_timeout 10s;
            
            # Allow publishing from anywhere (auth handled by callback)
            allow publish all;
            
            # Deny direct RTMP playback (use HLS/DASH instead)
            deny play all;

            # HLS output with adaptive bitrate
            exec_push /scripts/transcode.sh $name $app;
            
            # Alternative: Direct HLS without transcoding (lower CPU)
            # hls on;
            # hls_path /tmp/hls;
            # hls_fragment 2s;
            # hls_playlist_length 10s;
            # hls_nested on;
            # hls_cleanup on;
        }

        # Application for transcoded streams (internal use)
        application hls {
            live on;
            
            # HLS settings
            hls on;
            hls_path /tmp/hls;
            hls_fragment 2s;
            hls_playlist_length 10s;
            hls_nested on;
            hls_cleanup on;
            
            # Create variant playlist for adaptive streaming
            hls_variant _1080p BANDWIDTH=5000000,RESOLUTION=1920x1080;
            hls_variant _720p BANDWIDTH=2500000,RESOLUTION=1280x720;
            hls_variant _480p BANDWIDTH=1000000,RESOLUTION=854x480;
            hls_variant _360p BANDWIDTH=500000,RESOLUTION=640x360;
            
            # DASH output (optional)
            # dash on;
            # dash_path /tmp/dash;
            # dash_fragment 2s;
            # dash_playlist_length 10s;
            # dash_nested on;
            # dash_cleanup on;
            
            allow publish 127.0.0.1;
            deny publish all;
            deny play all;
        }

        # Low-latency streaming application
        application low-latency {
            live on;
            
            # Minimal buffering for low latency
            wait_key on;
            wait_video on;
            
            # Authentication
            on_publish http://127.0.0.1:3000/api/streams/auth/publish;
            on_publish_done http://127.0.0.1:3000/api/streams/auth/publish-done;
            
            # HLS with shorter fragments for lower latency
            hls on;
            hls_path /tmp/hls/low-latency;
            hls_fragment 1s;
            hls_playlist_length 4s;
            hls_nested on;
            hls_cleanup on;
            
            allow publish all;
            deny play all;
        }

        # Relay application for multi-destination streaming
        application relay {
            live on;
            
            # Push to external services (configured via API)
            # push rtmp://a.rtmp.youtube.com/live2/${youtube_key};
            # push rtmp://live.twitch.tv/app/${twitch_key};
            
            on_publish http://127.0.0.1:3000/api/streams/auth/publish;
            on_publish_done http://127.0.0.1:3000/api/streams/auth/publish-done;
            
            allow publish all;
            deny play all;
        }
    }
}
